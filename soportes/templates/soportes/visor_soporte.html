{% extends "base.html" %}

{% block content %}
<style>
/* üîπ Tipograf√≠a y contenedor principal */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
#container {
    display: flex;
    gap: 20px;
    margin-top: 20px;
}

/* üîπ Panel izquierdo */
#panel-izquierdo {
    width: 28%;
}

/* üîπ Bloques de categor√≠a */
.categoria-bloque {
    background-color: #ffffff;
    border-radius: 10px;
    border: 1px solid #ced4da; /* Marco visible */
    padding: 12px;
    margin-bottom: 15px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08); /* Sombra ligera */
    transition: all 0.2s;
}
.categoria-bloque:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}
.categoria-bloque h3 {
    font-size: 1rem;
    color: #495057;
    margin-bottom: 8px;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 4px;
}

/* üîπ Lista de documentos */
.lista-documentos {
    list-style: none;
    padding-left: 0;
    margin: 0;
}
.lista-documentos li {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 5px;
    margin-bottom: 6px;
}
.lista-documentos a.doc-link {
    text-decoration: none;
    color: #0d6efd;
    padding: 4px 8px;
    border-radius: 5px;
    background-color: #e7f1ff;
    font-weight: 500;
    font-size: 0.85rem;
    transition: all 0.2s;
}
.lista-documentos a.doc-link:hover {
    background-color: #0d6efd;
    color: white;
}
.btn-eliminar {
    background-color: #dc3545;
    color: white;
    font-size: 0.7rem;
    padding: 2px 5px;
    border-radius: 4px;
    text-decoration: none;
    transition: all 0.2s;
    cursor: pointer;
}
.btn-eliminar:hover {
    background-color: #bb2d3b;
}

/* üîπ Panel derecho */
#panel-derecho {
    width: 72%;
    background-color: #ffffff;
    border-radius: 10px;
    padding: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}
iframe {
    width: 100%;
    height: 650px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
}

/* üîπ Botones generales */
.btn, .btn-primary {
    display: inline-block;
    padding: 8px 15px;
    margin-top: 10px;
    border-radius: 6px;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s;
}
.btn {
    background-color: #28a745;
    color: white;
}
.btn:hover {
    background-color: #218838;
}
.btn-primary {
    background-color: #0d6efd;
    color: white;
}
.btn-primary:hover {
    background-color: #0a58ca;
}

/* üîπ T√≠tulo */
h2 {
    color: #343a40;
    margin-bottom: 15px;
    border-bottom: 2px solid #dee2e6;
    padding-bottom: 6px;
}
</style>

<h2>Soportes del n√∫mero de control: {{ numero_control }}</h2>

<div id="container">
    <!-- üîπ Panel izquierdo -->
    <div id="panel-izquierdo">
        {% for categoria, documentos in categorias.items %}
            <div class="categoria-bloque">
                <h3>{{ categoria }}</h3>
                <ul class="lista-documentos">
                    {% for doc in documentos %}
                        <li id="soporte-{{ doc.id }}">
                            {% if doc.archivo %}
                                <a href="#" class="doc-link" data-url="{{ doc.archivo.url }}">
                                    üìÑ {{ doc.descripcion|default:doc.get_tipo_display|default:"Soporte" }}
                                </a>
                                <span class="btn-eliminar" data-id="{{ doc.id }}">üóëÔ∏è</span>
                            {% elif doc.pdf_url %}
                                <a href="#" class="doc-link" data-url="{{ doc.pdf_url }}">
                                    üåê {{ doc.get_tipo_display|default:categoria }}
                                </a>
                            {% else %}
                                <span class="text-muted" style="font-size:0.85rem;">Sin documento</span>
                            {% endif %}
                        </li>
                    {% empty %}
                        <li class="text-muted" style="font-size:0.85rem;">Sin documentos</li>
                    {% endfor %}
                </ul>
            </div>
        {% endfor %}

        <!-- üîπ Botones de acci√≥n -->
        <a href="{% url 'soportes:descargar_paquete' numero_control %}" class="btn">üì¶ Descargar paquete</a>
        <a href="{% url 'soportes:cargar_soporte' numero_control %}" class="btn btn-primary">üì§ Cargar soporte</a>
    </div>

    <!-- üîπ Panel derecho -->
    <div id="panel-derecho">
        <iframe id="visor-documento" src=""></iframe>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const links = document.querySelectorAll(".doc-link");
    const ifrm = document.getElementById("visor-documento");

    // Mostrar documento en iframe
    links.forEach(link => {
        link.addEventListener("click", function(e) {
            e.preventDefault();
            const url = this.dataset.url;
            if(url) ifrm.src = url;
            else alert("No hay documento disponible para mostrar.");
        });
    });

    // Eliminar soporte con AJAX
    const botonesEliminar = document.querySelectorAll(".btn-eliminar");
    botonesEliminar.forEach(btn => {
        btn.addEventListener("click", function() {
            const soporteId = this.dataset.id;
            if(confirm("¬øEst√° seguro de eliminar este soporte?")) {
                fetch(`/soportes/eliminar/${soporteId}/`, {method: 'GET'})
                .then(resp => resp.json())
                .then(data => {
                    if(data.status === 'ok'){
                        const li = document.getElementById(`soporte-${soporteId}`);
                        li.remove(); // Elimina del visor
                        alert(data.mensaje);
                    } else {
                        alert(data.mensaje);
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Error al eliminar el soporte.");
                });
            }
        });
    });
});
</script>
{% endblock %}
